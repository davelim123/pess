<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Police Emergency Service System</title>
<link href="header_style.css" rel="stylesheet" type="text/css">
<link href="content_style.css" rel="stylesheet" type="text/css">
</head>
<body>
<?php
if (isset($_POST["btnDispatch"]))
{ 
require_once 'db.php';
?>
<?php 
if (!isset($_POST["btnProcessCall"]) && !isset($_POST["btnDispatch"]))
header("Location: logcall.php");
?>
<form name="form1" method="post" action="<?php echo htmlentities($_SERVER['PHP_SELF']); ?> ">
<table>
	<tr>
		<td colspan="2">Incident Detail</td>
	</tr>
	<tr>
		<td>Caller's Name :</td>
		<td><?php echo $_POST['callerName'] ?>
			<input type="hidden" name="callerName" id="callerName"
			value="<?php echo $_POST['callerName'] ?>"></td>
	</tr>
	<tr>
		<td>Contact No :</td>
		<td><?php echo $_POST['Contact No'] ?> 
			<input type="hidden" name="ContactNo" id="ContactNo"
			value="<?php echo $_POST['ContactNo'] ?>"></td>
	</tr>
	<tr>
		<td>Location :</td>
		<td><?php echo $_POST['Location'] ?> 
			<input type="hidden" name="Location" id="Location"
			value="<?php echo $_POST['Location'] ?>"></td>
	</tr>
	<tr>
		<td>Incident Type :</td>
		<td><?php echo $_POST['Incident Type'] ?> 
			<input type="hidden" name="Incident Type" id="Incident Type"
			value="<?php echo $_POST['Incident Type'] ?>"></td>
	</tr>
	<tr>
		<td>Description :</td>
		<td><textarea name="incidentDesc" cols="45"
		<td><textarea name="incidentDesc"><?php echo $_POST['incidentDesc'] ?></
textarea>
		<input name="incidentDesc" type="hidden"
		id="incidentDesc" value="<?php echo $_POST['incidentDesc'] ?>"></td>
	</tr>
</table>
</form>
<table>
	<tr>
		<td colspan="3">Dispatch Patrolcar Panel</td>
	</tr>
	<?php
		foreach($patrolcarArray as $key=>$value){
	?>
	<tr>
		<td><input type="checkbox" name="chkPatrolcar[]"
			value="<?php echo $key?>"></td>
			<td><?php echo $key ?></td>
			<td><?php echo $value ?></td>
	</tr>
	<?php	}	?>
	<tr>
		<td><input type="reset"	name="btnCancel id="btnCanel" value="Reset"></td>
		<td colspan="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit"
	name="btnDispatch" id="btnDispatch" value="Dispatch">
		</td>
	   </tr>
</table>
</body>
</html>
<?php
// connect to a database
require_once 'db.php';
//Create connection
$conn = new mysqli(DB_SERVER, DB_USER, DB_PASSWORD, DB_DATABASE);
// Check connection
if	($conn->connect_error) {
	die("Connection failed: " . $conn->connnect_error);
}

// retrive from patrolcar table those patrol cars that are 2:Patrol or 3:Free
$sql = "SELECT patrolcar_id, patrolcar_statues_desc FROM patrolcar JOIN
patrolcar_status ON patrolcar.patrolcar_status_id=patrolcar_status.patrolcar_status_id 
WHERE patrolcar.patrolcar_status_id= '2' OR patrolcar.patrolcar.patrolcar_status_id='3'";

$result = $conn->query($sql);

if ($result->num_rows > 0) {
	while ($row = $result->fetch_assoc()) {
	$patrolcarArray[$row['patrolcar_id']] = $row['patrolcar_status_desc'];
	}
}
$conn->close();
?>
<!-- populate table with patrol car data -->

<?php
// if postback via clicking Dispatch button
if (isset (§_POST ("btnDispatch"]))
{
	require once 'db.php';

	// Create connection
	$conn = new mysqli (DB_ SERVER, DB USER, DB PASSWORD, DB DATABASE) :
	// Check connection
	if (Sconn-›connect error) {
	die ("Connection failed: " . $conn-›connect error);
}
	
	$patrolcarDispatched = $ POST ("chkPatrolcar"): // array of patrolcar being dispatched from post back
	Snum0fPatrocarDispatched = count ($patrolcarDispatched):

	if ($numOfPatrocarDispatched › 0) {
	Sincidentstatug='2';	// incident status to be set as Dispatched
	} else {
		$incidentStatus='1';	// incident status to be set as Pending
	}
	$sql = "INSERT INTO incident (caller name, phone number, incident type id,
	incident location, incident desc, incident stätus Id) VALUES ('".S POST('callerName
	']."',	'".$_POST['contactNo']."',	'".$_POST['incidentType']."',	'".$_POST[
	'location']."',	'".$_POST['incidentDesc']."',	$incidentStatus)";
	if (Sconn-›query ($sq]) ===FALSE)
	echo "Error: " . $sql . "<br>" . $conn->error
}
	// retrieve incident id for the newly inserted incident
	$incidentId-mysqli_insert_id(Sconn);;

	// update patrolcar status table and add into dispatch table
	for (Si=0; Si < SnumOfPatrocarDispatched; $i++)
	{
	// update patro car status /////////////
	$sql = "UPDATE patrolcar SET patrolcar_status_id='1' WHERE patrolcar id = '".
	$patrolcarDispatched[$i]."'";

	if ($conn->query($sql) ===FALSE) {
	echo "Error: " $sql . "(br>" . $conn->error;
	}
	
	// insert dispatch data ////////////////
	$sql = "INSERT INTO dispatch (incident_id, patrolcar_id, time_dispatched)
VALUES ($incidentId,	'".SpatrolcarDispatched[$i]."', Now())";

	if (Sconn->query ($sq]) ===FALSE)
	echo "Error: " $sql . "(br>" $conn->error;
	}
   }
	$conn->close();

?>	